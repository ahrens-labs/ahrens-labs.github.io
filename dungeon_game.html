<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Game - Ahrens Labs</title>
    
    <!-- Google Fonts Links -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --border-light: #475569;
            --bg-log: #0f172a;
            --text-log: #e2e8f0;
        }

        body.light-theme {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #cbd5e1;
            --border-light: #e2e8f0;
            --bg-log: #f1f5f9;
            --text-log: #1e293b;
        }

        body { 
            font-family: 'JetBrains+Mono', monospace; 
            overflow-x: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .combat-active { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { background-color: rgba(220, 38, 38, 0.05); } 50% { background-color: rgba(220, 38, 38, 0.15); } }
        .equipped { border-color: #fbbf24 !important; background-color: rgba(251, 191, 36, 0.1) !important; }
        
        /* Game wrapper styles */
        .game-wrapper {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: calc(100vh - 200px);
            padding: 2rem 1rem;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Theme toggle button */
        #theme-toggle-btn {
            padding: 8px 16px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #theme-toggle-btn:hover {
            background: #4f46e5;
        }

        /* Game UI Elements - Log Panel */
        #game-log {
            background-color: var(--bg-log) !important;
            color: var(--text-log) !important;
        }

        /* Board/Viewport */
        #viewport {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }

        /* Stats header boxes */
        .bg-slate-900 { 
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }
        .bg-slate-800 { 
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }
        .border-slate-800 { border-color: var(--border-color) !important; }
        .text-slate-400, .text-slate-500 { color: var(--text-secondary) !important; }
        .text-slate-600 { color: var(--text-muted) !important; }
        .text-white { color: var(--text-primary) !important; }

        /* Buttons and interactive elements */
        .hover\:bg-slate-700:hover {
            background-color: var(--bg-secondary) !important;
        }

        /* Log entries */
        #game-log > div {
            color: var(--text-log) !important;
        }

        /* Footer styling for light theme */
        footer {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
</head>
<body>
    <script>
        // Initialize theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('dungeon-game-theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
            }
        })();
    </script>
    <div class="wrapper">
        <header>
            <div class="header-content">
                <a href="index.html" class="logo-link">
                    <img src="img/EagleLogo.png" alt="Ahrens Labs logo" class="header-logo">
                </a>
                <h1>Ahrens Labs</h1>
                <nav>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="labs.html">Labs & Projects</a></li>
                        <li><a href="contact.html">Contact</a></li>
                        <li><a href="chess_engine.html">Chess Engine</a></li>
                    </ul>
                </nav>
                <div id="header-auth-buttons" style="position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; align-items: center; z-index: 1000;">
                    <button id="header-login-btn" onclick="window.location.href='account.html'" style="padding: 6px 14px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.3s; white-space: nowrap;">Login</button>
                    <button id="header-signup-btn" onclick="window.location.href='account.html'" style="padding: 6px 14px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.3s; white-space: nowrap;">Sign Up</button>
                    <button id="header-logout-btn" onclick="handleLogout()" style="display: none; padding: 6px 14px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.3s; white-space: nowrap;">Logout</button>
                    <span id="header-username" style="display: none; padding: 6px 14px; color: white; font-weight: 600; font-size: 0.9em; white-space: nowrap;"></span>
                </div>
            </div>
        </header>

        <main class="game-wrapper flex flex-col items-center">

    <!-- Header Stats -->
    <div id="stats-header" class="w-full max-w-4xl grid grid-cols-2 md:grid-cols-5 gap-3 mb-4 hidden">
        <div class="bg-slate-900 border border-slate-800 p-3 rounded flex items-center gap-3">
            <i class="fas fa-heart text-red-500 text-lg"></i>
            <div>
                <div class="text-xs text-slate-500 font-bold uppercase">Health</div>
                <div id="stat-hp" class="text-white text-base font-bold">--/--</div>
            </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 p-3 rounded flex items-center gap-3">
            <i class="fas fa-coins text-yellow-500 text-lg"></i>
            <div>
                <div class="text-xs text-slate-500 font-bold uppercase">Gold</div>
                <div id="stat-gold" class="text-white text-base font-bold">0</div>
            </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 p-3 rounded flex items-center gap-3">
            <i class="fas fa-key text-blue-400 text-lg"></i>
            <div>
                <div class="text-xs text-slate-500 font-bold uppercase">Keys</div>
                <div id="stat-keys" class="text-white text-base font-bold">0</div>
            </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 p-3 rounded flex items-center gap-3">
            <i class="fas fa-shield-alt text-slate-400 text-lg"></i>
            <div>
                <div class="text-xs text-slate-500 font-bold uppercase">Armor</div>
                <div id="stat-armor" class="text-white text-base font-bold">--</div>
            </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 p-4 rounded">
            <div class="flex items-center justify-between gap-4 mb-3 pb-3 border-b border-slate-800">
                <div id="stat-floor" class="text-base text-blue-400 font-black">FLOOR 1</div>
                <div id="stat-level" class="text-base text-purple-400 font-black">LVL 1</div>
            </div>
            <div id="stat-exp" class="text-sm text-cyan-400 font-bold mb-2">EXP: 0/100</div>
            <div id="stat-attributes" class="text-sm text-slate-400 font-semibold">S:0 D:0 I:0 W:0</div>
        </div>
    </div>

    <!-- Main Game Container -->
    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-4 gap-4 flex-1">
        <!-- Log Panel -->
        <div class="lg:col-span-1 bg-black border border-slate-800 rounded flex flex-col h-[300px] lg:h-[600px] overflow-hidden">
            <div class="bg-slate-900 p-3 text-sm font-bold border-b border-slate-800 text-slate-500 flex justify-between items-center">
                <span>ADVENTURE LOG</span>
                <button id="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Light/Dark Theme" style="padding: 4px 8px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.75em; transition: all 0.3s; display: flex; align-items: center; gap: 4px;">
                    <i class="fas fa-moon"></i>
                    <span id="theme-text" style="font-size: 0.9em;">Dark</span>
                </button>
            </div>
            <div id="game-log" class="flex-1 overflow-y-auto p-4 text-[13px] space-y-2 custom-scrollbar bg-slate-950/50"></div>
            <div id="global-actions" class="p-3 border-t border-slate-800 bg-slate-900 hidden">
                <button onclick="toggleInventory()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-sm font-bold rounded uppercase flex items-center justify-center gap-2">
                    <i class="fas fa-backpack text-base"></i> Inventory
                </button>
            </div>
        </div>

        <!-- Viewport -->
        <div id="viewport" class="lg:col-span-3 bg-slate-900 border border-slate-800 rounded p-6 relative flex flex-col items-center justify-center min-h-[500px] shadow-2xl transition-all duration-500">
            
            <div id="view-menu" class="text-center space-y-8">
                <h1 class="text-6xl font-black text-white italic tracking-tighter">DUNGEON<br>GAME</h1>
                <div class="flex flex-col gap-3">
                    <button onclick="initCharacterCreation()" class="bg-white text-black px-12 py-4 rounded font-bold text-lg hover:bg-yellow-400 transition-all shadow-xl">NEW GAME</button>
                    <button onclick="loadGame()" class="bg-slate-800 text-white px-12 py-4 rounded font-bold text-lg hover:bg-slate-700 transition-all shadow-xl border border-slate-700">LOAD GAME</button>
                </div>
            </div>

            <div id="view-creation" class="hidden w-full max-w-sm space-y-4">
                <div id="char-name-input" class="space-y-4">
                    <h2 class="text-lg font-bold text-center text-slate-400 uppercase tracking-widest">Create Your Character</h2>
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-400 uppercase">Character Name</label>
                        <input id="character-name" type="text" maxlength="20" placeholder="Enter name..." class="w-full p-4 bg-slate-800 border border-slate-700 rounded text-white text-base focus:border-blue-500 focus:outline-none">
                    </div>
                    <button onclick="confirmCharacterName()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 rounded font-bold uppercase text-base">Continue</button>
                </div>
                <div id="attr-assignment" class="hidden space-y-4">
                    <h2 class="text-lg font-bold text-center text-slate-400 uppercase tracking-widest">Assign Attributes</h2>
                    <div id="rolls-container" class="flex justify-center gap-2"></div>
                    <div id="attr-selection" class="space-y-1"></div>
                </div>
            </div>

            <div id="view-town" class="hidden text-center space-y-6 w-full max-w-lg">
                <h2 class="text-4xl font-black text-white italic">OAKHAVEN</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showShop()" class="p-10 bg-slate-800 rounded hover:bg-slate-700 border border-slate-700 flex flex-col items-center gap-3">
                        <i class="fas fa-store text-4xl text-yellow-500"></i>
                        <span class="font-bold text-lg">SHOP</span>
                    </button>
                    <button onclick="enterDungeon()" class="p-10 bg-slate-800 rounded hover:bg-slate-700 border border-slate-700 flex flex-col items-center gap-3">
                        <i class="fas fa-dungeon text-4xl text-red-500"></i>
                        <span class="font-bold text-lg">DUNGEON</span>
                    </button>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="saveGame()" class="text-sm text-slate-500 hover:text-white underline font-bold">SAVE GAME</button>
                    <button onclick="showChangeNameModal()" class="text-sm text-slate-500 hover:text-white underline font-bold">CHANGE NAME</button>
                </div>
            </div>

            <div id="view-dungeon" class="hidden w-full flex flex-col items-center gap-6">
                <div id="mini-map" class="grid grid-cols-10 gap-2 bg-slate-950 p-6 rounded border-2 border-slate-800"></div>
                <div id="room-actions" class="flex flex-wrap justify-center gap-3 min-h-[40px]"></div>
                <div class="grid grid-cols-3 gap-2 w-48">
                    <div></div><button onclick="movePlayer(-1, 0)" class="h-14 w-14 bg-slate-800 rounded hover:bg-slate-700 flex items-center justify-center text-xl">&#9650;</button><div></div>
                    <button onclick="movePlayer(0, -1)" class="h-14 w-14 bg-slate-800 rounded hover:bg-slate-700 flex items-center justify-center text-xl">&#9664;</button>
                    <button onclick="movePlayer(1, 0)" class="h-14 w-14 bg-slate-800 rounded hover:bg-slate-700 flex items-center justify-center text-xl">&#9660;</button>
                    <button onclick="movePlayer(0, 1)" class="h-14 w-14 bg-slate-800 rounded hover:bg-slate-700 flex items-center justify-center text-xl">&#9654;</button>
                </div>
                <div class="flex gap-4">
                    <button id="btn-return-town" onclick="showView('view-town')" class="hidden text-sm text-slate-500 hover:text-white uppercase font-bold mt-4 flex items-center gap-2">
                        <i class="fas fa-door-open"></i> Return to Town
                    </button>
                    <button onclick="saveGame()" class="text-sm text-slate-500 hover:text-white uppercase font-bold mt-4 flex items-center gap-2">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>

            <!-- COMBAT VIEW -->
            <div id="view-combat" class="hidden w-full flex flex-col items-center gap-6">
                <div class="text-center w-full">
                    <div id="monster-name" class="text-red-500 font-black text-3xl uppercase italic tracking-widest">MONSTER</div>
                    <div class="w-full max-w-sm mx-auto h-3 bg-slate-950 rounded mt-3 overflow-hidden border border-slate-800">
                        <div id="monster-hp-bar" class="h-full bg-red-600 transition-all duration-500" style="width: 100%"></div>
                    </div>
                    <div id="monster-stats-display" class="text-sm text-slate-500 mt-2"></div>
                </div>

                <div id="combat-main-menu" class="hidden grid grid-cols-1 gap-3 w-full max-w-xs">
                    <button onclick="showCombatSubMenu('attack')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded font-bold text-base text-left px-6 flex justify-between items-center">
                        <span>ATTACK</span><i class="fas fa-sword text-slate-600 text-lg"></i>
                    </button>
                    <button onclick="showCombatSubMenu('items')" class="p-4 bg-slate-800 hover:bg-slate-700 rounded font-bold text-base text-left px-6 flex justify-between items-center">
                        <span>ITEMS</span><i class="fas fa-flask text-slate-600 text-lg"></i>
                    </button>
                    <button onclick="retreat()" class="p-4 bg-slate-900 border border-blue-900/40 text-blue-400 hover:bg-blue-950/20 rounded font-bold text-base text-left px-6 flex justify-between items-center">
                        <span>RETREAT (Roll)</span><i class="fas fa-person-running text-lg"></i>
                    </button>
                </div>

                <div id="combat-direction-menu" class="hidden grid grid-cols-3 gap-3 w-full max-w-md">
                    <div class="col-span-3 text-center text-sm font-bold text-yellow-500 mb-2 uppercase italic">Target Strike Area</div>
                    <button onclick="combatAction(1)" class="p-5 bg-slate-800 hover:bg-red-900/50 rounded flex flex-col items-center text-sm font-bold">HIGH</button>
                    <button onclick="combatAction(3)" class="p-5 bg-slate-800 hover:bg-red-900/50 rounded flex flex-col items-center text-sm font-bold">MID</button>
                    <button onclick="combatAction(2)" class="p-5 bg-slate-800 hover:bg-red-900/50 rounded flex flex-col items-center text-sm font-bold">LOW</button>
                    <button onclick="showCombatSubMenu('main')" class="col-span-3 text-sm text-slate-500 font-bold text-center mt-2">BACK</button>
                </div>

                <div id="combat-defense-menu" class="hidden grid grid-cols-3 gap-3 w-full max-w-md">
                    <div class="col-span-3 text-center text-sm font-bold text-blue-400 mb-2 uppercase italic">Guard Position!</div>
                    <button onclick="resolveMonsterTurn(1)" class="p-5 bg-blue-900/20 hover:bg-blue-800/40 rounded border border-blue-500/30 flex flex-col items-center text-sm font-bold">HIGH</button>
                    <button onclick="resolveMonsterTurn(3)" class="p-5 bg-blue-900/20 hover:bg-blue-800/40 rounded border border-blue-500/30 flex flex-col items-center text-sm font-bold">MID</button>
                    <button onclick="resolveMonsterTurn(2)" class="p-5 bg-blue-900/20 hover:bg-blue-800/40 rounded border border-blue-500/30 flex flex-col items-center text-sm font-bold">LOW</button>
                </div>

                <div id="combat-items-menu" class="hidden w-full max-w-xs space-y-2">
                    <div id="combat-inventory-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar"></div>
                    <button onclick="showCombatSubMenu('main')" class="w-full p-3 bg-slate-800 text-sm text-slate-500 rounded font-bold">BACK</button>
                </div>

                <div id="turn-indicator" class="text-sm font-black tracking-widest text-yellow-600 bg-black/40 px-6 py-2 rounded italic uppercase">...</div>
            </div>

            <!-- SHOP VIEW -->
            <div id="view-shop" class="hidden w-full h-full overflow-y-auto custom-scrollbar p-2">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-900 py-3 border-b border-slate-800">
                    <h2 class="font-black text-2xl italic">TOWN MERCHANT</h2>
                    <div class="flex gap-2">
                        <button id="shop-mode-buy" onclick="setShopMode('buy')" class="text-sm bg-yellow-600 px-4 py-2 rounded font-bold">BUY</button>
                        <button id="shop-mode-sell" onclick="setShopMode('sell')" class="text-sm bg-slate-800 px-4 py-2 rounded font-bold">SELL</button>
                        <button onclick="showView('view-town')" class="text-sm bg-slate-800 px-4 py-2 rounded font-bold">EXIT</button>
                    </div>
                </div>
                <div id="shop-categories" class="space-y-6"></div>
            </div>

            <!-- INVENTORY VIEW -->
            <div id="view-inventory" class="hidden w-full h-full overflow-y-auto custom-scrollbar p-2">
                <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-900 py-3 border-b border-slate-800 z-10">
                    <h2 class="font-black text-2xl italic">INVENTORY</h2>
                    <button onclick="closeInventory()" class="text-sm bg-slate-800 px-4 py-2 rounded font-bold">CLOSE</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-2">Weapons</h3>
                        <div id="inv-weapons" class="space-y-2"></div>
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-2">Armor</h3>
                        <div id="inv-armors" class="space-y-2"></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-2">Consumables</h3>
                        <div id="inv-consumables" class="space-y-2"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="js/script.js"></script>
    <script>
        // ===============================================
        // THEME TOGGLE SYSTEM
        // ===============================================
        function initTheme() {
            const savedTheme = localStorage.getItem('dungeon-game-theme') || 'dark';
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            const body = document.body;
            const themeBtn = document.getElementById('theme-toggle-btn');
            const themeText = document.getElementById('theme-text');
            const themeIcon = themeBtn.querySelector('i');

            if (theme === 'light') {
                body.classList.add('light-theme');
                themeText.textContent = 'Light';
                themeIcon.className = 'fas fa-sun';
            } else {
                body.classList.remove('light-theme');
                themeText.textContent = 'Dark';
                themeIcon.className = 'fas fa-moon';
            }
            
            localStorage.setItem('dungeon-game-theme', theme);
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        // Initialize theme on page load
        initTheme();
        // CLOUD SAVE SYSTEM
        // ===============================================
        const API_BASE_URL = 'https://chess-accounts.matthewahrens.workers.dev';
        let currentSaveSlot = null;
        let isLoggedIn = false;
        let sessionId = null;

        // Check authentication on page load
        async function checkAuth() {
            sessionId = localStorage.getItem('ahrenslabs_sessionId');
            if (!sessionId) {
                // Redirect to account page with return URL
                window.location.href = 'account.html?return=dungeon_game.html';
                return false;
            }

            // Verify session is valid
            try {
                const response = await fetch(`${API_BASE_URL}/api/user`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });
                
                if (!response.ok) {
                    window.location.href = 'account.html?return=dungeon_game.html';
                    return false;
                }
                
                isLoggedIn = true;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'account.html?return=dungeon_game.html';
                return false;
            }
        }

        // Save game to cloud slot
        async function saveToCloud(slotNumber, saveName) {
            if (!isLoggedIn || !sessionId) return false;

            const slot = `slot${slotNumber}`;
            
            // Determine current location (in town or in dungeon)
            const currentView = document.querySelector('#viewport > div:not(.hidden)')?.id;
            const inTown = currentView === 'view-town';
            
            const saveData = {
                stats: stats,
                map: floorMaps,
                monsters: monsterData,
                room: currentRoom,
                openedChests: Array.from(stats.openedChests),
                inTown: inTown
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/dungeon/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({
                        slot: slot,
                        data: saveData,
                        name: saveName || stats.characterName || `Save ${slotNumber}`
                    })
                });

                const result = await response.json();
                if (result.success) {
                    currentSaveSlot = slotNumber;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Save to cloud failed:', error);
                return false;
            }
        }

        // Load game from cloud slot
        async function loadFromCloud(slotNumber) {
            if (!isLoggedIn || !sessionId) return null;

            const slot = `slot${slotNumber}`;

            try {
                const response = await fetch(`${API_BASE_URL}/api/dungeon/load`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ slot })
                });

                const result = await response.json();
                if (result && result.data) {
                    currentSaveSlot = slotNumber;
                    return result.data;
                }
                return null;
            } catch (error) {
                console.error('Load from cloud failed:', error);
                return null;
            }
        }

        // Get all save slots
        async function getAllSaveSlots() {
            if (!isLoggedIn || !sessionId) return {};

            try {
                const response = await fetch(`${API_BASE_URL}/api/dungeon/slots`, {
                    headers: {
                        'Authorization': `Bearer ${sessionId}`
                    }
                });

                const slots = await response.json();
                return slots;
            } catch (error) {
                console.error('Get save slots failed:', error);
                return {};
            }
        }

        // Delete save slot
        async function deleteSaveSlot(slotNumber) {
            if (!isLoggedIn || !sessionId) return false;

            const slot = `slot${slotNumber}`;

            try {
                const response = await fetch(`${API_BASE_URL}/api/dungeon/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionId}`
                    },
                    body: JSON.stringify({ slot })
                });

                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Delete save slot failed:', error);
                return false;
            }
        }

        // Auto-save (debounced)
        let autoSaveTimeout;
        function triggerAutoSave() {
            if (!currentSaveSlot) return;
            
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                await saveToCloud(currentSaveSlot, `Auto-save ${currentSaveSlot}`);
                addLog('Game auto-saved', 'text-green-400');
            }, 3000); // Auto-save 3 seconds after last action
        }

        // ===============================================
        // ORIGINAL GAME DATA
        // ===============================================
        
        // Helper function to get weapon damage description
        function getWeaponDamageDesc(tier) {
            const damages = {
                1: "1d3 (1-3 damage)",
                2: "1d6 (1-6 damage)",
                3: "1d10 (1-10 damage)",
                4: "2d6+2 (4-14 damage)",
                5: "3d6+3 (6-21 damage)",
                6: "4d6+4 (8-28 damage)"
            };
            return damages[tier] || "Unknown";
        }
        
        // --- DATA MATCHING PYTHON EXACTLY ---
        // [Cost, Value, Type(1=Wep,2=Arm,3=Pot,4=Spl), Effect/Uses]
        const SHOP_DATA = {
            "dagger": [30, 2, 1],
            "short sword": [50, 3, 1],
            "long sword": [100, 4, 1],
            "axe": [200, 5, 1],
            "great sword": [500, 6, 1],
            "paded armor": [125, 10, 2],
            "leather armor": [200, 11, 2],
            "studded leather": [400, 12, 2],
            "scale mail": [700, 13, 2],
            "chainmail": [1000, 14, 2],
            "platemail": [1500, 15, 2],
            "healing potion": [25, 3, 3, 1],
            "intelligence potion": [70, 2, 3, 2],
            "speed potion": [100, 2, 3, 3],
            "strength potion": [130, 2, 3, 4],
            "protection potion": [150, 2, 3, 5],
            "magic missile spell": [50, 3, 4, 1],
            "weakness spell": [70, 2, 4, 2],
            "lightning spell": [100, 2, 4, 3],
            "freeze spell": [130, 2, 4, 4],
            "fireball spell": [150, 2, 4, 5],
            "town spell": [200, 2, 4, 6]
        };

        // --- GAME STATE ---
        let stats = {
            characterName: "",
            HP: 15, maxHP: 15, coins: 0, armor: 9, keys: 0, floor: 1,
            exp: 0, level: 1, totalExp: 0, expToNextLevel: 100,
            strength: 0, dexterity: 0, intelligence: 0, wisdom: 0,
            temporary_strength: 0, temporary_dexterity: 0, temporary_intelligence: 0, temporary_armor: 0,
            weapons: { "stick": 1 }, 
            armors: { "none": 9 }, 
            potions: {}, 
            spells: {},
            equippedWeapon: "stick",
            equippedArmor: "none",
            openedChests: new Set(),
            deathCount: 0  // Track number of deaths for difficulty scaling
        };
        let floorMaps = {}; // Store maps per floor
        let monsterData = {}; // Store pre-generated monster stats by room
        let currentRoom = [9, 9];
        let pendingRolls = [];
        let combatData = null;
        let isProcessing = false;
        let previousView = "view-town";
        let shopMode = "buy";

        // --- CORE UTILS ---
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        async function logLoading(text, dots = 3, speed = 250) {
            const log = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = "text-slate-500 italic";
            log.appendChild(entry);
            for(let i=0; i<3; i++) {
                for(let d=1; d<=dots; d++) {
                    entry.innerText = `${text}${'.'.repeat(d)}`;
                    log.scrollTop = log.scrollHeight;
                    await sleep(speed);
                }
            }
            entry.remove();
        }

        function addLog(msg, color="text-slate-400") {
            const log = document.getElementById('game-log');
            const d = document.createElement('div');
            d.className = `${color} leading-snug`;
            d.innerText = msg;
            log.appendChild(d);
            log.scrollTop = log.scrollHeight;
        }

        function updateUI() {
            document.getElementById('stat-hp').innerText = `${stats.HP}/${stats.maxHP}`;
            document.getElementById('stat-gold').innerText = stats.coins;
            document.getElementById('stat-keys').innerText = stats.keys;
            document.getElementById('stat-armor').innerText = stats.armor + stats.temporary_armor;
            document.getElementById('stat-floor').innerText = `FLOOR ${stats.floor}`;
            document.getElementById('stat-level').innerText = `LVL ${stats.level}`;
            document.getElementById('stat-exp').innerText = `EXP: ${stats.totalExp}/${stats.expToNextLevel}`;
            document.getElementById('stat-attributes').innerText = `S:${stats.strength} D:${stats.dexterity} I:${stats.intelligence} W:${stats.wisdom}`;
            
            const btn = document.getElementById('btn-return-town');
            if (currentRoom[0] === 9 && currentRoom[1] === 9) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        function showView(viewId) {
            // Store the current view BEFORE hiding everything
            const currentView = document.querySelector('#viewport > div:not(.hidden)')?.id;
            
            // Only update previousView when opening inventory (to remember where to return)
            if (viewId === "view-inventory" && currentView && currentView !== "view-inventory") {
                previousView = currentView;
            }
            // When closing inventory or doing any other transition, DON'T update previousView
            
            ['view-menu','view-creation','view-town','view-dungeon','view-combat','view-shop','view-inventory'].forEach(v => 
                document.getElementById(v).classList.add('hidden')
            );
            
            document.getElementById('viewport').classList.toggle('combat-active', viewId === 'view-combat');
            document.getElementById(viewId).classList.remove('hidden');
            
            if(viewId !== 'view-menu') {
                document.getElementById('stats-header').classList.remove('hidden');
                document.getElementById('global-actions').classList.remove('hidden');
            }
            if(viewId === 'view-dungeon') updateUI();
        }

        function toggleInventory() {
            if (!document.getElementById('view-inventory').classList.contains('hidden')) {
                closeInventory();
            } else {
                renderInventory();
                showView('view-inventory');
            }
        }

        function closeInventory() {
            // If we're returning to combat, make sure combat state is still valid
            if (previousView === 'view-combat') {
                if (combatData && combatData.HP > 0) {
                    // Combat is still active, restore it
                    showView('view-combat');
                    updateCombatUI();
                    // Restore the appropriate menu based on whose turn it is
                    if (combatData.turn === 'player') {
                        showCombatSubMenu('main');
                    } else if (combatData.turn === 'monster') {
                        showCombatSubMenu('defense');
                    }
                } else {
                    // Combat ended while in inventory, go back to dungeon
                    showView('view-dungeon');
                    renderDungeon();
                    checkRoom(true);
                }
            } else {
                showView(previousView);
            }
        }

        async function saveGame() {
            // Show save slot selection modal
            showSaveSlotModal();
        }

        async function loadGame() {
            // Check authentication before loading
            if (!isLoggedIn) {
                addLog('Please log in to load your game!', 'text-red-400');
                window.location.href = 'account.html?return=dungeon_game.html';
                return;
            }
            // Show load slot selection modal
            showLoadSlotModal();
        }

        // Show save slot selection modal
        async function showSaveSlotModal() {
            const slots = await getAllSaveSlots();
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:500px;width:90%;">';
            html += '<h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1.5rem;text-align:center;color:white;">SAVE TO SLOT</h2>';
            html += '<div style="display:flex;flex-direction:column;gap:1rem;">';
            
            for (let i = 1; i <= 3; i++) {
                const slot = slots[`slot${i}`];
                const slotName = slot ? slot.name : `Empty Slot ${i}`;
                const slotDate = slot ? new Date(slot.savedAt).toLocaleString() : '';
                const currentCharName = stats.characterName || 'Unnamed Hero';
                
                html += `<button onclick="saveToSlotAndClose(${i})" style="padding:1rem;background:#334155;border-radius:8px;text-align:left;cursor:pointer;border:2px solid #475569;transition:all 0.2s;color:white;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#334155'">`;
                html += `<div style="font-weight:bold;font-size:1.1rem;">Slot ${i}</div>`;
                if (slot) {
                    html += `<div style="font-size:0.9rem;color:#fbbf24;">${slotName}</div>`;
                    html += `<div style="font-size:0.8rem;color:#94a3b8;">${slotDate}</div>`;
                } else {
                    html += `<div style="font-size:0.9rem;color:#64748b;">Empty</div>`;
                }
                html += `<div style="font-size:0.75rem;color:#3b82f6;margin-top:0.25rem;">Will save: ${currentCharName}</div>`;
                html += '</button>';
            }
            
            html += '</div>';
            html += '<button onclick="closeSaveModal()" style="margin-top:1.5rem;width:100%;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;">CANCEL</button>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'save-modal';
            document.body.appendChild(modal);
        }

        // Show load slot selection modal
        async function showLoadSlotModal() {
            const slots = await getAllSaveSlots();
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:500px;width:90%;">';
            html += '<h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1.5rem;text-align:center;color:white;">LOAD FROM SLOT</h2>';
            html += '<div style="display:flex;flex-direction:column;gap:1rem;">';
            
            for (let i = 1; i <= 3; i++) {
                const slot = slots[`slot${i}`];
                const slotDate = slot ? new Date(slot.savedAt).toLocaleString() : '';
                
                if (slot) {
                    const characterName = slot.name || `Save ${i}`;
                    html += `<div style="padding:1rem;background:#334155;border-radius:8px;border:2px solid #475569;display:flex;justify-content:space-between;align-items:center;">`;
                    html += `<div style="flex:1;cursor:pointer;color:white;" onclick="loadFromSlotAndClose(${i})">`;
                    html += `<div style="font-weight:bold;font-size:1.1rem;">Slot ${i}</div>`;
                    html += `<div style="font-size:1rem;color:#fbbf24;">${characterName}</div>`;
                    html += `<div style="font-size:0.8rem;color:#94a3b8;">${slotDate}</div>`;
                    html += `</div>`;
                    html += `<button onclick="deleteSlotAndRefresh(${i})" style="padding:0.5rem 1rem;background:#ef4444;border-radius:6px;font-size:0.8rem;font-weight:bold;color:white;cursor:pointer;">DELETE</button>`;
                    html += '</div>';
                } else {
                    html += `<div style="padding:1rem;background:#1e293b;border-radius:8px;border:2px solid #334155;color:#64748b;">`;
                    html += `<div style="font-weight:bold;">Slot ${i}: Empty</div>`;
                    html += '</div>';
                }
            }
            
            html += '</div>';
            html += '<button onclick="closeLoadModal()" style="margin-top:1.5rem;width:100%;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;">CANCEL</button>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'load-modal';
            document.body.appendChild(modal);
        }

        async function saveToSlotAndClose(slotNumber) {
            const saveName = stats.characterName || `Save ${slotNumber}`;
            const success = await saveToCloud(slotNumber, saveName);
            if (success) {
                addLog(`Game saved to Slot ${slotNumber}!`, 'text-green-400');
                closeSaveModal();
            } else {
                addLog('Failed to save game', 'text-red-400');
            }
        }

        async function loadFromSlotAndClose(slotNumber) {
            const saveData = await loadFromCloud(slotNumber);
            if (saveData) {
                stats = saveData.stats;
                floorMaps = saveData.map || {};
                monsterData = saveData.monsters || {};
                currentRoom = saveData.room;
                stats.openedChests = new Set(saveData.openedChests);
                
                // Check if player was in town when they saved
                const wasInTown = saveData.inTown === true;
                
                if (wasInTown) {
                    // Load into town
                    showView('view-town');
                    addLog(`Game loaded from Slot ${slotNumber}!`, 'text-yellow-400');
                    addLog(`Welcome back to Oakhaven, ${stats.characterName || 'adventurer'}!`, 'text-slate-400');
                } else {
                    // Load into dungeon
                    showView('view-dungeon');
                    renderDungeon();
                    addLog(`Game loaded from Slot ${slotNumber}!`, 'text-yellow-400');
                    // Check room for events (including battles) - don't suppress
                    checkRoom(false);
                }
                
                updateUI();
                closeLoadModal();
            } else {
                addLog('Failed to load game', 'text-red-400');
            }
        }

        function deleteSlotAndRefresh(slotNumber) {
            showDeleteConfirmation(slotNumber);
        }

        function showDeleteConfirmation(slotNumber) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:11000;';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:400px;width:90%;border:3px solid #ef4444;">';
            html += '<div style="text-align:center;font-size:3rem;margin-bottom:1rem;">⚠️</div>';
            html += '<h2 style="font-size:1.3rem;font-weight:bold;margin-bottom:1rem;text-align:center;color:#ef4444;">DELETE SAVE?</h2>';
            html += '<div style="background:#0f172a;padding:1.5rem;border-radius:8px;margin-bottom:1.5rem;border:2px solid #7f1d1d;text-align:center;">';
            html += `<div style="font-size:1.1rem;font-weight:bold;color:#fbbf24;margin-bottom:0.5rem;">Save Slot ${slotNumber}</div>`;
            html += '<div style="font-size:0.9rem;color:#ef4444;font-weight:bold;margin-top:1rem;">This action cannot be undone!</div>';
            html += '</div>';
            html += '<div style="display:flex;gap:0.75rem;flex-direction:column;">';
            html += `<button onclick="confirmDelete(${slotNumber})" style="width:100%;padding:0.75rem;background:#ef4444;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">DELETE SAVE</button>`;
            html += '<button onclick="closeDeleteModal()" style="width:100%;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">CANCEL</button>';
            html += '</div>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'delete-modal';
            document.body.appendChild(modal);
        }

        async function confirmDelete(slotNumber) {
            closeDeleteModal();
            const success = await deleteSaveSlot(slotNumber);
            if (success) {
                addLog(`Deleted save slot ${slotNumber}`, 'text-red-400');
                closeLoadModal();
                setTimeout(() => showLoadSlotModal(), 100);
            } else {
                addLog('Failed to delete save', 'text-red-400');
            }
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            if (modal) modal.remove();
        }

        function closeSaveModal() {
            const modal = document.getElementById('save-modal');
            if (modal) modal.remove();
        }

        function closeLoadModal() {
            const modal = document.getElementById('load-modal');
            if (modal) modal.remove();
        }

        // --- CHANGE CHARACTER NAME ---
        function showChangeNameModal() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:450px;width:90%;">';
            html += '<h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1.5rem;text-align:center;color:white;">CHANGE CHARACTER NAME</h2>';
            html += '<div style="background:#0f172a;padding:1.5rem;border-radius:8px;margin-bottom:1rem;border:2px solid #334155;">';
            html += `<div style="font-size:0.9rem;color:#94a3b8;margin-bottom:0.5rem;">Current Name:</div>`;
            html += `<div style="font-size:1.2rem;font-weight:bold;color:#fbbf24;margin-bottom:1rem;">${stats.characterName || 'Unnamed'}</div>`;
            html += '<div style="font-size:0.9rem;color:#94a3b8;margin-bottom:0.5rem;">New Name:</div>';
            html += '<input id="new-character-name" type="text" maxlength="20" placeholder="Enter new name..." style="width:100%;padding:0.75rem;background:#1e293b;border:2px solid #475569;border-radius:6px;color:white;font-size:1rem;outline:none;" />';
            html += '</div>';
            html += '<div style="display:flex;gap:0.75rem;">';
            html += '<button onclick="confirmNameChange()" style="flex:1;padding:0.75rem;background:#3b82f6;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">CHANGE NAME</button>';
            html += '<button onclick="closeChangeNameModal()" style="flex:1;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">CANCEL</button>';
            html += '</div>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'change-name-modal';
            document.body.appendChild(modal);
            
            // Focus the input field
            setTimeout(() => {
                document.getElementById('new-character-name').focus();
            }, 100);
        }

        function confirmNameChange() {
            const newName = document.getElementById('new-character-name').value.trim();
            
            if (newName === '') {
                addLog('Please enter a valid name!', 'text-red-400');
                return;
            }
            
            const oldName = stats.characterName || 'Unnamed';
            stats.characterName = newName;
            
            closeChangeNameModal();
            addLog(`Character name changed from "${oldName}" to "${newName}"`, 'text-blue-400');
            addLog('Remember to save your game to keep the new name!', 'text-yellow-400');
        }

        function closeChangeNameModal() {
            const modal = document.getElementById('change-name-modal');
            if (modal) modal.remove();
        }

        // --- CHARACTER CREATION ---
        function create_value() {
            const rolls = Array.from({length:4}, () => Math.floor(Math.random()*6)+1);
            return rolls.reduce((a,b)=>a+b,0) - Math.min(...rolls);
        }

        function initCharacterCreation() {
            // Show character name input first
            document.getElementById('char-name-input').classList.remove('hidden');
            document.getElementById('attr-assignment').classList.add('hidden');
            document.getElementById('character-name').value = '';
            showView('view-creation');
        }
        
        function confirmCharacterName() {
            const nameInput = document.getElementById('character-name').value.trim();
            if (nameInput === '') {
                addLog('Please enter a character name!', 'text-red-400');
                return;
            }
            stats.characterName = nameInput;
            
            // Now proceed to attribute assignment
            pendingRolls = [create_value(), create_value(), create_value(), create_value()];
            stats.coins = 0;
            for(let i=0; i<20; i++) stats.coins += Math.floor(Math.random()*6)+1;
            
            document.getElementById('char-name-input').classList.add('hidden');
            document.getElementById('attr-assignment').classList.remove('hidden');
            renderCreation();
        }

        function renderCreation() {
            const rc = document.getElementById('rolls-container');
            rc.innerHTML = '';
            pendingRolls.forEach(r => {
                const b = document.createElement('div');
                b.className = "w-10 h-10 bg-slate-800 border border-slate-700 flex items-center justify-center font-bold text-yellow-500 rounded";
                b.innerText = r;
                rc.appendChild(b);
            });

            const ac = document.getElementById('attr-selection');
            ac.innerHTML = '';
            ['strength', 'wisdom', 'dexterity', 'intelligence'].forEach(attr => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center p-2 bg-slate-800/30 rounded";
                row.innerHTML = `<span class="capitalize text-sm font-bold text-slate-400">${attr}</span>`;
                const group = document.createElement('div');
                group.className = "flex gap-1";
                if(stats[attr] === 0 || stats[attr] === null) {
                    pendingRolls.forEach((r, i) => {
                        const btn = document.createElement('button');
                        btn.className = "w-10 h-10 bg-blue-600 rounded text-sm font-bold";
                        btn.innerText = r;
                        btn.onclick = () => {
                            stats[attr] = r;
                            pendingRolls.splice(i, 1);
                            if(pendingRolls.length === 0) {
                                showView('view-town');
                                updateUI();
                            } else renderCreation();
                        };
                        group.appendChild(btn);
                    });
                } else {
                    group.innerHTML = `<span class="text-green-500 font-bold text-sm">${stats[attr]}</span>`;
                }
                row.appendChild(group);
                ac.appendChild(row);
            });
        }

        // --- DUNGEON ---
        function generateMonsterStats(type) {
            let mStats = {};
            if (type === 'wandering') {
                mStats = {
                    HP: 0, 
                    armor: Math.floor(Math.random()*3)+8,
                    attack: Math.floor(Math.random()*2)+1,
                    strength: Math.floor(Math.random()*3)-1,
                    dexterity: Math.floor(Math.random()*4)+8,
                    change_strength: false, freeze: 0, fire: false
                };
                for(let i=0; i<3; i++) mStats.HP += Math.floor(Math.random()*4)+1;
            } else if (type === 'normal') {
                mStats = {
                    HP: Math.floor(Math.random()*10)+Math.floor(Math.random()*10)+Math.floor(Math.random()*10)+5,
                    armor: Math.floor(Math.random()*3)+11,
                    attack: Math.floor(Math.random()*2)+2,
                    strength: Math.floor(Math.random()*3)+1,
                    dexterity: Math.floor(Math.random()*4)+10,
                    change_strength: false, freeze: 0, fire: false
                };
            } else if (type === 'mini') {
                mStats = {
                    HP: Math.floor(Math.random()*20)+50,
                    armor: Math.floor(Math.random()*3)+14,
                    attack: Math.floor(Math.random()*2)+4,
                    strength: Math.floor(Math.random()*3)+3,
                    dexterity: Math.floor(Math.random()*4)+12,
                    change_strength: false, freeze: 0, fire: false
                };
            } else if (type === 'boss') {
                mStats = {
                    HP: 0, 
                    armor: Math.floor(Math.random()*4)+16,
                    attack: Math.floor(Math.random()*2)+5,
                    strength: Math.floor(Math.random()*4)+4,
                    dexterity: Math.floor(Math.random()*5)+14,
                    change_strength: false, freeze: 0, fire: false
                };
                for(let i=0; i<20; i++) mStats.HP += Math.floor(Math.random()*6)+1;
            }
            return mStats;
        }

        function generateRoom(row, col) {
            let val = 10000000;
            const r1 = Math.floor(Math.random()*4)+1;
            if (r1 === 1) { // Chest
                if(Math.floor(Math.random()*3)+1 === 1) val += 10;
                else val += 1;
            }
            const r2 = Math.floor(Math.random()*4)+1;
            if (r2 === 1) { // Monster
                if(Math.floor(Math.random()*3)+1 === 1) {
                    val += 1000;
                    monsterData[`${row},${col},${stats.floor}`] = generateMonsterStats('wandering');
                } else {
                    val += 100;
                    monsterData[`${row},${col},${stats.floor}`] = generateMonsterStats('normal');
                }
            }
            if (Math.floor(Math.random()*12)+1 === 1) val += 10000;
            if (Math.floor(Math.random()*20)+1 === 1) { // Boss
                if(Math.floor(Math.random()*3)+1 === 1) {
                    val += 1000000;
                    monsterData[`${row},${col},${stats.floor}`] = generateMonsterStats('boss');
                } else {
                    val += 100000;
                    monsterData[`${row},${col},${stats.floor}`] = generateMonsterStats('mini');
                }
            }
            return val;
        }

        function enterDungeon() {
            const floorKey = `floor_${stats.floor}`;
            if(!floorMaps[floorKey]) {
                floorMaps[floorKey] = Array.from({length:10}, (_, row) => 
                    Array.from({length:10}, (_, col) => generateRoom(row, col))
                );
            }
            currentRoom = [9, 9];
            showView('view-dungeon');
            renderDungeon();
            checkRoom();
        }

        function renderDungeon() {
            const mapEl = document.getElementById('mini-map');
            mapEl.innerHTML = '';
            for(let r=0; r<10; r++) {
                for(let c=0; c<10; c++) {
                    const isPlayer = r===currentRoom[0] && c===currentRoom[1];
                    const cell = document.createElement('div');
                    cell.className = `w-6 h-6 rounded ${isPlayer ? 'bg-blue-400 shadow-[0_0_10px_rgba(96,165,250,0.8)]' : 'bg-slate-800'}`;
                    mapEl.appendChild(cell);
                }
            }
        }

        function movePlayer(dr, dc) {
            if (isProcessing) return;
            const nr = currentRoom[0] + dr, nc = currentRoom[1] + dc;
            if(nr >= 0 && nr < 10 && nc >= 0 && nc < 10) {
                currentRoom = [nr, nc];
                renderDungeon();
                updateUI();
                checkRoom();
            }
        }

        function checkRoom(suppressEvents = false) {
            if(suppressEvents) return;
            const floorKey = `floor_${stats.floor}`;
            const val = String(floorMaps[floorKey][currentRoom[0]][currentRoom[1]]).padStart(8, '0');
            const act = document.getElementById('room-actions');
            act.innerHTML = '';

            // Check for permanent room encounters first
            if (val[1] === '1') return showPreCombatSavePrompt("BOSS", "boss");
            if (val[2] === '1') return showPreCombatSavePrompt("MINI-BOSS", "mini");
            if (val[4] === '1') return showPreCombatSavePrompt("WANDERING MONSTER", "wandering");
            if (val[5] === '1') return showPreCombatSavePrompt("MONSTER", "normal");
            
            // Random wandering monster spawn (25% chance in any room)
            // This gives the same likelihood in visited and unvisited rooms
            if (Math.random() < 0.25) {
                return showPreCombatSavePrompt("WANDERING MONSTER", "wandering");
            }
            
            if (val[6] === '1') createChestBtn(act, true);
            if (val[7] === '1') createChestBtn(act, false);
            
            if (val[3] === '1') {
                const b = document.createElement('button');
                b.className = "px-6 py-3 bg-blue-700 hover:bg-blue-600 rounded text-sm font-bold uppercase";
                b.innerText = "Stairs Down";
                b.onclick = () => {
                    stats.floor++;
                    addLog(`Descending to Floor ${stats.floor}...`, "text-blue-400 font-bold");
                    enterDungeon();
                };
                act.appendChild(b);
            }
        }

        function createChestBtn(p, isBig) {
            const chestId = `chest_${currentRoom[0]}_${currentRoom[1]}_${stats.floor}`;
            const b = document.createElement('button');
            b.className = "px-6 py-3 bg-yellow-700 hover:bg-yellow-600 rounded text-sm font-bold uppercase";
            b.innerText = isBig ? "Open Big Chest" : "Open Small Chest";
            
            if(stats.openedChests.has(chestId)) return;

            b.onclick = async () => {
                if (isProcessing) return;
                isProcessing = true;
                
                if (isBig) {
                    addLog("Big Chest! Attempting to unlock with Intelligence...", "text-yellow-400");
                    
                    const statVal = stats.intelligence + stats.temporary_intelligence;
                    await logLoading("Rolling Intelligence", 3, 200);
                    const baseRoll = Math.floor(Math.random()*20)+1;
                    const mod = Math.floor(statVal / 2) - 5;
                    const roll = baseRoll + mod;
                    const need = Math.floor(Math.random()*5)+10;
                    addLog(`Rolled ${baseRoll} + ${mod} = ${roll}. Need ${need}.`);
                    
                    if (roll >= need) {
                        addLog("Success! You cleverly unlock the chest!", "text-green-500 font-bold");
                        const loot = Math.floor(Math.random()*71)+30;  // 30-100 gold
                        stats.coins += loot;
                        addLog(`Found ${loot} coins!`, "text-yellow-500");
                        
                        // 1/3 chance to find a random potion or spell
                        if (Math.floor(Math.random()*3) === 0) {
                            const isPotionNotSpell = Math.random() < 0.5;
                            const potionNames = ["healing potion", "intelligence potion", "speed potion", "strength potion", "protection potion"];
                            const spellNames = ["magic missile spell", "weakness spell", "lightning spell", "freeze spell", "fireball spell"];
                            
                            const itemList = isPotionNotSpell ? potionNames : spellNames;
                            const itemName = itemList[Math.floor(Math.random() * itemList.length)];
                            const itemData = SHOP_DATA[itemName];
                            
                            if (isPotionNotSpell) {
                                if(!stats.potions[itemName]) stats.potions[itemName] = [0, itemData[3]];
                                stats.potions[itemName][0]++;
                                addLog(`Found a ${itemName}!`, "text-purple-400 font-bold");
                            } else {
                                if(!stats.spells[itemName]) stats.spells[itemName] = [0, itemData[3]];
                                stats.spells[itemName][0]++;
                                addLog(`Found a ${itemName}!`, "text-purple-400 font-bold");
                            }
                        }
                        
                        const floorKey = `floor_${stats.floor}`;
                        floorMaps[floorKey][currentRoom[0]][currentRoom[1]] -= 10;
                        stats.openedChests.add(chestId);
                    } else {
                        addLog("Failed! The chest remains locked.", "text-red-500");
                        const floorKey = `floor_${stats.floor}`;
                        floorMaps[floorKey][currentRoom[0]][currentRoom[1]] -= 10;
                    }
                    
                    stats.temporary_intelligence = 0;
                    isProcessing = false;
                    checkRoom();
                    updateUI();
                } else {
                    if (Math.floor(Math.random()*3)+1 !== 1) {
                        const loot = Math.floor(Math.random()*36)+5;
                        stats.coins += loot;
                        addLog(`Found ${loot} coins.`, "text-yellow-500");
                        const floorKey = `floor_${stats.floor}`;
                        floorMaps[floorKey][currentRoom[0]][currentRoom[1]] -= 1;
                    } else {
                        addLog("The chest was empty.", "text-slate-500");
                    }
                    isProcessing = false;
                    checkRoom();
                    updateUI();
                }
            };
            p.appendChild(b);
        }

        // --- COMBAT ---
        function showPreCombatSavePrompt(name, type) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            const monsterIcon = type === 'boss' ? '👹' : type === 'mini' ? '😈' : '👾';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:400px;width:90%;border:3px solid #dc2626;">';
            html += `<div style="text-align:center;font-size:3rem;margin-bottom:1rem;">${monsterIcon}</div>`;
            html += '<h2 style="font-size:1.3rem;font-weight:bold;margin-bottom:1rem;text-align:center;color:#ef4444;">BATTLE AHEAD!</h2>';
            html += '<div style="background:#0f172a;padding:1.5rem;border-radius:8px;margin-bottom:1rem;border:2px solid #7f1d1d;text-align:center;">';
            html += `<div style="font-size:1.1rem;font-weight:bold;color:#fbbf24;text-transform:uppercase;margin-bottom:0.5rem;">${name}</div>`;
            html += `<div style="font-size:0.9rem;color:#94a3b8;">You are about to enter combat!</div>`;
            html += '</div>';
            html += '<div style="font-size:0.85rem;color:#94a3b8;text-align:center;margin-bottom:1.5rem;">Would you like to save your game first?</div>';
            html += '<div style="display:flex;gap:0.75rem;flex-direction:column;">';
            html += `<button onclick="saveBeforeCombat('${name}', '${type}')" style="width:100%;padding:0.75rem;background:#10b981;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">SAVE & FIGHT</button>`;
            html += `<button onclick="proceedToCombat('${name}', '${type}')" style="width:100%;padding:0.75rem;background:#dc2626;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">FIGHT NOW</button>`;
            html += '</div>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'pre-combat-modal';
            document.body.appendChild(modal);
        }

        async function saveBeforeCombat(name, type) {
            closePreCombatModal();
            // Show save slot modal
            const slots = await getAllSaveSlots();
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:500px;width:90%;">';
            html += '<h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1.5rem;text-align:center;color:white;">QUICK SAVE</h2>';
            html += '<div style="display:flex;flex-direction:column;gap:1rem;">';
            
            for (let i = 1; i <= 3; i++) {
                const slot = slots[`slot${i}`];
                const slotDate = slot ? new Date(slot.savedAt).toLocaleString() : '';
                const currentCharName = stats.characterName || 'Unnamed Hero';
                
                html += `<button onclick="quickSaveAndFight(${i}, '${name}', '${type}')" style="padding:1rem;background:#334155;border-radius:8px;text-align:left;cursor:pointer;border:2px solid #475569;transition:all 0.2s;color:white;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#334155'">`;
                html += `<div style="font-weight:bold;font-size:1.1rem;">Slot ${i}</div>`;
                if (slot) {
                    html += `<div style="font-size:0.9rem;color:#fbbf24;">${slot.name}</div>`;
                    html += `<div style="font-size:0.8rem;color:#94a3b8;">${slotDate}</div>`;
                } else {
                    html += `<div style="font-size:0.9rem;color:#64748b;">Empty</div>`;
                }
                html += `<div style="font-size:0.75rem;color:#3b82f6;margin-top:0.25rem;">Will save: ${currentCharName}</div>`;
                html += '</button>';
            }
            
            html += '</div>';
            html += `<button onclick="cancelQuickSave('${name}', '${type}')" style="margin-top:1.5rem;width:100%;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;">SKIP & FIGHT</button>`;
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'quick-save-modal';
            document.body.appendChild(modal);
        }

        async function quickSaveAndFight(slotNumber, name, type) {
            const saveName = stats.characterName || `Save ${slotNumber}`;
            const success = await saveToCloud(slotNumber, saveName);
            if (success) {
                addLog(`Game saved to Slot ${slotNumber}!`, 'text-green-400');
            }
            closeQuickSaveModal();
            startCombat(name, type);
        }

        function cancelQuickSave(name, type) {
            closeQuickSaveModal();
            startCombat(name, type);
        }

        function proceedToCombat(name, type) {
            closePreCombatModal();
            startCombat(name, type);
        }

        function closePreCombatModal() {
            const modal = document.getElementById('pre-combat-modal');
            if (modal) modal.remove();
        }

        function closeQuickSaveModal() {
            const modal = document.getElementById('quick-save-modal');
            if (modal) modal.remove();
        }

        async function startCombat(name, type) {
            let mStats = {};
            
            // Check if this is a pre-generated monster from the map
            const monsterKey = `${currentRoom[0]},${currentRoom[1]},${stats.floor}`;
            if (monsterData[monsterKey]) {
                // Use pre-generated stats
                mStats = {...monsterData[monsterKey]};
            } else {
                // Generate new stats for random wandering monsters
                mStats = generateMonsterStats(type);
            }

            combatData = { ...mStats, name, type, maxHp: mStats.HP, turn: 'init' };
            showView('view-combat');
            document.getElementById('monster-name').innerText = name;
            document.getElementById('monster-stats-display').innerText = `Dexterity: ${mStats.dexterity}`;
            updateCombatUI();
            addLog(`Encountered ${name}!`, "text-red-500 font-bold uppercase");
            
            isProcessing = true;
            await logLoading("Rolling Initiative", 3, 100);
            if (Math.random() < 0.5) {
                addLog("You act first!", "text-blue-400");
                combatData.turn = 'player';
                showCombatSubMenu('main');
                isProcessing = false;
            } else {
                addLog(`${name} acts first!`, "text-red-400");
                combatData.turn = 'monster';
                isProcessing = false;
                monsterTurnStart();
            }
            updateCombatUI();
        }

        async function retreat() {
            if(isProcessing) return;
            isProcessing = true;
            await logLoading("Attempting Retreat", 3, 200);
            const baseRoll = Math.floor(Math.random()*20)+1;
            const mod = Math.floor((stats.dexterity + stats.temporary_dexterity)/2)-5;
            const roll = baseRoll + mod;
            stats.temporary_dexterity = 0;
            addLog(`Dex Roll: ${baseRoll} + ${mod} = ${roll} vs ${combatData.dexterity}`, "text-yellow-400");
            if (roll >= combatData.dexterity) {
                addLog("Retreat Successful!", "text-green-500 font-bold");
                showView('view-dungeon');
                renderDungeon();
                checkRoom(true);
            } else {
                addLog("Retreat Failed!", "text-red-500 font-bold");
                await sleep(500);
                combatData.turn = 'monster';
                monsterTurnStart();
            }
            isProcessing = false;
        }

        function showCombatSubMenu(menu) {
            document.getElementById('combat-main-menu').classList.toggle('hidden', menu !== 'main');
            document.getElementById('combat-direction-menu').classList.toggle('hidden', menu !== 'attack');
            document.getElementById('combat-items-menu').classList.toggle('hidden', menu !== 'items');
            document.getElementById('combat-defense-menu').classList.toggle('hidden', menu !== 'defense');
            if (menu === 'items') renderCombatInventory();
        }

        function updateCombatUI() {
            const p = Math.max(0, (combatData.HP / combatData.maxHp) * 100);
            document.getElementById('monster-hp-bar').style.width = `${p}%`;
            document.getElementById('turn-indicator').innerText = combatData.turn.toUpperCase() + ' TURN';
        }

        async function combatAction(dir) {
            if (isProcessing) return;
            isProcessing = true;
            showCombatSubMenu('none');
            await logLoading("Rolling Hit", 3, 100);
            const baseRoll = Math.floor(Math.random()*20)+1;
            const mod = Math.floor((stats.strength + stats.temporary_strength)/2)-5;
            const roll = baseRoll + mod;
            stats.temporary_strength = 0;
            addLog(`Str Roll: ${baseRoll} + ${mod} = ${roll} vs AC ${combatData.armor}`);
            if (roll >= combatData.armor) {
                addLog("HIT!", "text-green-400 font-bold");
                await logLoading("Damage", 3, 100);
                const tier = stats.weapons[stats.equippedWeapon] || 1;
                let dmg = 0;
                if(tier===1) dmg = Math.floor(Math.random()*3)+1;
                else if(tier===2) dmg = Math.floor(Math.random()*6)+1;
                else if(tier===3) dmg = Math.floor(Math.random()*10)+1;
                else if(tier===4) dmg = Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+2;
                else if(tier===5) dmg = Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+3;
                else dmg = Math.floor(Math.random()*6)*4 + 4;
                const mDir = Math.floor(Math.random()*3)+1;
                if(mDir === dir) {
                    dmg = Math.floor(dmg/2);
                    addLog(`Monster Blocked! Half damage (${dmg})`, "text-slate-400");
                } else addLog(`Dealt ${dmg} damage!`, "text-green-400");
                combatData.HP -= dmg;
                if(combatData.HP <= 0) { await victory(); return; }
            } else addLog("MISS!", "text-red-400");
            updateCombatUI();
            await sleep(500);
            if(combatData.HP > 0) {
                combatData.turn = 'monster';
                isProcessing = false;
                monsterTurnStart();
            }
        }

        async function monsterTurnStart() {
            if(combatData.freeze > 0) {
                combatData.freeze--;
                addLog("Monster is Frozen!", "text-cyan-400");
                await sleep(800);
                combatData.turn = 'player';
                updateCombatUI();
                showCombatSubMenu('main');
                return;
            }
            if(combatData.fire) {
                combatData.HP -= 2;
                addLog("Monster took 2 fire damage.", "text-orange-400");
                if(combatData.HP <= 0) { await victory(); return; }
            }
            showCombatSubMenu('defense');
        }

        async function resolveMonsterTurn(defDir) {
            if (isProcessing) return;
            isProcessing = true;
            showCombatSubMenu('none');
            await logLoading("Monster Attacking", 3, 100);
            if(combatData.change_strength) {
                combatData.strength += 2;
                combatData.change_strength = false;
                addLog("Monster strength increased!", "text-red-500");
            }
            const roll = Math.floor(Math.random()*20)+1 + combatData.strength;
            const ac = stats.armor + stats.temporary_armor;
            addLog(`Monster Roll: ${roll} vs AC ${ac}`);
            if (roll >= ac) {
                addLog("YOU WERE HIT!", "text-red-600 font-bold");
                let dmg = 0;
                const tier = combatData.attack;
                if(tier<=1) dmg = Math.floor(Math.random()*3)+1;
                else if(tier===2) dmg = Math.floor(Math.random()*6)+1;
                else if(tier===3) dmg = Math.floor(Math.random()*10)+1;
                else if(tier===4) dmg = Math.floor(Math.random()*6)*2+2;
                else if(tier===5) dmg = Math.floor(Math.random()*6)*3+3;
                else dmg = Math.floor(Math.random()*6)*4+4;
                const atkDir = Math.floor(Math.random()*3)+1;
                if(atkDir === defDir) {
                    dmg = Math.floor(dmg/2);
                    addLog(`Blocked! Half damage (${dmg})`, "text-blue-400");
                } else addLog(`Took ${dmg} damage!`, "text-red-500");
                stats.HP -= dmg;
                updateUI();
                if(stats.HP <= 0) {
                    handleDeath();
                    return;
                }
            } else addLog("Monster Missed!", "text-green-400");
            stats.temporary_armor = 0;
            await sleep(500);
            combatData.turn = 'player';
            isProcessing = false;
            updateCombatUI();
            showCombatSubMenu('main');
        }

        async function handleDeath() {
            addLog("YOU DIED.", "text-red-900 font-black text-2xl");
            isProcessing = true;
            
            await sleep(1500);
            
            // Wisdom test difficulty increases with each death
            // Base DC is 10, +2 for each previous death
            const baseDC = 10;
            const deathPenalty = stats.deathCount * 2;
            const targetDC = baseDC + deathPenalty;
            
            addLog("Your spirit lingers between life and death...", "text-purple-400 italic");
            await sleep(1000);
            addLog("Make a Wisdom saving throw to return to the living!", "text-yellow-400 font-bold");
            await logLoading("Rolling", 3, 300);
            
            const roll = Math.floor(Math.random()*20)+1;
            const wisdomMod = Math.floor(stats.wisdom / 2) - 5;
            const total = roll + wisdomMod;
            
            addLog(`Rolled ${roll} + ${wisdomMod} (Wisdom) = ${total}`, "text-slate-300");
            addLog(`Need ${targetDC} or higher to revive`, "text-slate-400");
            
            await sleep(1500);
            
            if (total >= targetDC) {
                // SUCCESS - Revive with 2/3 health in town
                addLog("SUCCESS! Your spirit returns!", "text-green-400 font-black text-xl");
                stats.deathCount++;
                stats.HP = Math.floor(stats.maxHP * 2 / 3);
                
                await sleep(1000);
                addLog(`You awaken in Oakhaven with ${stats.HP} HP...`, "text-blue-400");
                addLog(`Death has left its mark. (Deaths: ${stats.deathCount})`, "text-red-400");
                
                // Return to town
                showView('view-town');
                updateUI();
                isProcessing = false;
            } else {
                // FAILURE - Permanent death
                addLog("FAILED... Your spirit fades into darkness.", "text-red-900 font-black text-xl");
                await sleep(2000);
                addLog("Game Over. Reloading...", "text-slate-500");
                await sleep(2000);
                location.reload();
            }
        }

        function calculateMonsterExp(monster) {
            // Base EXP by type
            let baseExp = 0;
            if (monster.type === 'wandering') baseExp = 20;
            else if (monster.type === 'normal') baseExp = 50;
            else if (monster.type === 'mini') baseExp = 150;
            else if (monster.type === 'boss') baseExp = 400;
            
            // Add bonus EXP based on monster stats (difficulty modifiers)
            const hpBonus = Math.floor(monster.maxHp / 10);  // 1 EXP per 10 HP
            const armorBonus = Math.max(0, (monster.armor - 10) * 3);  // 3 EXP per AC above 10
            const attackBonus = monster.attack * 5;  // 5 EXP per attack tier
            const strBonus = Math.max(0, monster.strength) * 4;  // 4 EXP per positive strength
            const dexBonus = Math.max(0, (monster.dexterity - 10) * 2);  // 2 EXP per dex above 10
            
            const totalExp = baseExp + hpBonus + armorBonus + attackBonus + strBonus + dexBonus;
            return Math.floor(totalExp);
        }

        async function victory() {
            addLog("VICTORY!", "text-yellow-400 font-black text-xl");
            
            // Better rewards based on monster type
            let coins = 0;
            if (combatData.type === 'wandering') {
                coins = Math.floor(Math.random()*21)+5;  // 5-25 gold
            } else if (combatData.type === 'normal') {
                coins = Math.floor(Math.random()*51)+25;  // 25-75 gold
            } else if (combatData.type === 'mini') {
                coins = Math.floor(Math.random()*101)+100;  // 100-200 gold
            } else if (combatData.type === 'boss') {
                coins = Math.floor(Math.random()*301)+200;  // 200-500 gold
            }
            
            stats.coins += coins;
            addLog(`Looted ${coins} coins.`, "text-yellow-500");
            
            // Award EXP
            const expGained = calculateMonsterExp(combatData);
            stats.exp += expGained;
            stats.totalExp += expGained;
            addLog(`Gained ${expGained} EXP! (${stats.totalExp}/${stats.expToNextLevel})`, "text-cyan-400");
            
            // Check for level up
            if (stats.exp >= stats.expToNextLevel) {
                await sleep(500);
                await levelUp();
            }
            
            // Remove monster from room
            let removeVal = 0;
            if(combatData.type.includes('boss')) removeVal = 1000000;
            else if(combatData.type.includes('mini')) removeVal = 100000;
            else if(combatData.type.includes('wandering')) removeVal = 1000;
            else removeVal = 100;
            const floorKey = `floor_${stats.floor}`;
            floorMaps[floorKey][currentRoom[0]][currentRoom[1]] -= removeVal;
            
            // Boss rewards
            if(combatData.type.includes('boss')) {
                stats.keys++;
                addLog("Found a Key!", "text-blue-400 font-bold");
            }
            
            // Mini-boss has chance to drop extra gold
            if(combatData.type === 'mini' && Math.random() < 0.5) {
                const bonus = Math.floor(Math.random()*51)+50;  // 50-100 extra
                stats.coins += bonus;
                addLog(`Found a hidden stash! +${bonus} gold!`, "text-yellow-400 font-bold");
            }
            
            await sleep(1000);
            isProcessing = false;
            updateUI();
            showView('view-dungeon');
            renderDungeon();
            checkRoom(true);
        }

        async function levelUp() {
            stats.level++;
            stats.exp = stats.exp - stats.expToNextLevel;
            stats.expToNextLevel = Math.floor(stats.expToNextLevel * 1.5);  // 50% increase per level
            
            addLog(`LEVEL UP! You are now level ${stats.level}!`, "text-purple-400 font-black text-xl");
            await sleep(1000);
            
            // Increase max HP with scaling dice rolls
            let hpGain = 0;
            let diceType = '';
            if (stats.level <= 3) {
                // Levels 1-3: 1d4 (1-4 HP)
                hpGain = Math.floor(Math.random()*4)+1;
                diceType = '1d4';
            } else if (stats.level <= 6) {
                // Levels 4-6: 1d6 (1-6 HP)
                hpGain = Math.floor(Math.random()*6)+1;
                diceType = '1d6';
            } else if (stats.level <= 9) {
                // Levels 7-9: 1d8 (1-8 HP)
                hpGain = Math.floor(Math.random()*8)+1;
                diceType = '1d8';
            } else if (stats.level <= 12) {
                // Levels 10-12: 1d10 (1-10 HP)
                hpGain = Math.floor(Math.random()*10)+1;
                diceType = '1d10';
            } else {
                // Levels 13+: 1d12 (1-12 HP)
                hpGain = Math.floor(Math.random()*12)+1;
                diceType = '1d12';
            }
            
            // Store HP gain data for later display
            const levelUpData = { hpGain, diceType, oldMaxHP: stats.maxHP };
            stats.maxHP += hpGain;
            stats.HP = stats.maxHP;  // Full heal on level up
            updateUI();
            
            // Calculate number of stat increases based on level
            // Level 1-3: 1 increase, Level 4-6: 2 increases, Level 7-9: 3 increases, etc.
            const numIncreases = Math.floor((stats.level - 1) / 3) + 1;
            
            await sleep(500);
            showStatIncreaseModal(1, numIncreases, levelUpData);  // Start with first increase
        }

        function showStatIncreaseModal(increaseNumber, totalIncreases, levelUpData) {
            const modal = document.createElement('div');
            modal.id = 'stat-increase-modal';
            modal.setAttribute('data-levelup', JSON.stringify(levelUpData));
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
                backdrop-filter: blur(4px);
            `;
            
            const statNames = [
                { key: 'strength', label: 'STRENGTH', desc: 'Melee damage' },
                { key: 'dexterity', label: 'DEXTERITY', desc: 'Hit chance & defense' },
                { key: 'intelligence', label: 'INTELLIGENCE', desc: 'Spell power & chests' },
                { key: 'wisdom', label: 'WISDOM', desc: 'Spell defense & death saves' }
            ];
            
            let buttonsHtml = '';
            statNames.forEach(stat => {
                const currentValue = stats[stat.key];
                buttonsHtml += `
                    <button onclick="increaseStat('${stat.key}', ${increaseNumber}, ${totalIncreases})" 
                        class="w-full bg-purple-800 hover:bg-purple-700 text-white px-6 py-4 rounded text-lg font-bold transition-colors border-2 border-purple-600">
                        <div class="flex justify-between items-center">
                            <div class="text-left">
                                <div>${stat.label}</div>
                                <div class="text-sm text-purple-300 font-normal">${stat.desc}</div>
                            </div>
                            <div class="text-2xl">${currentValue} → ${currentValue + 1}</div>
                        </div>
                    </button>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
                    border: 3px solid #a855f7; border-radius: 12px; padding: 32px; 
                    max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(168, 85, 247, 0.4);">
                    <h2 style="font-size: 28px; font-weight: bold; color: #a855f7; 
                        text-align: center; margin-bottom: 8px; text-transform: uppercase;">
                        🎉 Level Up! 🎉
                    </h2>
                    <p style="text-align: center; color: #cbd5e1; margin-bottom: 24px; font-size: 16px;">
                        Choose a stat to increase by 1 (${increaseNumber}/${totalIncreases}):
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function increaseStat(statName, increaseNumber, totalIncreases) {
            stats[statName]++;
            addLog(`${statName.toUpperCase()} increased to ${stats[statName]}!`, "text-purple-400 font-bold");
            
            const modal = document.getElementById('stat-increase-modal');
            const levelUpData = JSON.parse(modal.getAttribute('data-levelup'));
            
            closeStatIncreaseModal();
            updateUI();
            
            // If there are more increases remaining, show modal for next increase
            if (increaseNumber < totalIncreases) {
                await sleep(500);
                showStatIncreaseModal(increaseNumber + 1, totalIncreases, levelUpData);
            } else {
                // All stat increases complete - show HP completion modal
                await sleep(500);
                showHPCompletionModal(levelUpData);
            }
        }

        function showHPCompletionModal(levelUpData) {
            const modal = document.createElement('div');
            modal.id = 'hp-completion-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.85); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
                backdrop-filter: blur(4px);
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
                    border: 3px solid #10b981; border-radius: 12px; padding: 32px; 
                    max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(16, 185, 129, 0.4);">
                    <h2 style="font-size: 28px; font-weight: bold; color: #10b981; 
                        text-align: center; margin-bottom: 16px; text-transform: uppercase;">
                        ❤️ Health Boost! ❤️
                    </h2>
                    <div style="background: #0f172a; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 2px solid #334155;">
                        <div style="text-align: center; color: #cbd5e1; font-size: 16px; margin-bottom: 12px;">
                            Max HP Increased!
                        </div>
                        <div style="text-align: center; font-size: 32px; font-weight: bold; color: #10b981; margin-bottom: 12px;">
                            ${levelUpData.oldMaxHP} → ${stats.maxHP}
                        </div>
                        <div style="text-align: center; color: #94a3b8; font-size: 14px;">
                            Rolled ${levelUpData.diceType}: +${levelUpData.hpGain} HP
                        </div>
                    </div>
                    <div style="background: #059669; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                        <div style="text-align: center; color: white; font-size: 18px; font-weight: bold;">
                            ✨ Restored to Full Health! ✨
                        </div>
                        <div style="text-align: center; color: #d1fae5; font-size: 16px; margin-top: 8px;">
                            HP: ${stats.HP}/${stats.maxHP}
                        </div>
                    </div>
                    <button onclick="closeHPCompletionModal()" 
                        style="width: 100%; padding: 16px; background: #10b981; border-radius: 8px; 
                        font-weight: bold; color: white; font-size: 18px; cursor: pointer; border: none;
                        transition: background 0.2s;">
                        CONTINUE
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeHPCompletionModal() {
            const modal = document.getElementById('hp-completion-modal');
            if (modal) modal.remove();
        }

        function closeStatIncreaseModal() {
            const modal = document.getElementById('stat-increase-modal');
            if (modal) modal.remove();
        }

        // --- SHOP & SELLING ---
        function setShopMode(mode) {
            shopMode = mode;
            document.getElementById('shop-mode-buy').className = `text-sm ${mode==='buy'?'bg-yellow-600':'bg-slate-800'} px-4 py-2 rounded font-bold`;
            document.getElementById('shop-mode-sell').className = `text-sm ${mode==='sell'?'bg-yellow-600':'bg-slate-800'} px-4 py-2 rounded font-bold`;
            renderShop();
        }

        function showShop() {
            shopMode = "buy";
            setShopMode('buy');
            showView('view-shop');
        }

        function renderShop() {
            const container = document.getElementById('shop-categories');
            container.innerHTML = '';
            
            if (shopMode === 'buy') {
                const types = {1:"Weapons", 2:"Armor", 3:"Potions", 4:"Spells"};
                for(let t=1; t<=4; t++) {
                    const sect = document.createElement('div');
                    sect.innerHTML = `<h3 class="text-sm font-bold text-slate-500 mb-3 uppercase tracking-widest border-b border-slate-800 pb-2">${types[t]}</h3>`;
                    const list = document.createElement('div');
                    list.className = "grid grid-cols-2 gap-2 mb-4";
                    for(const [name, data] of Object.entries(SHOP_DATA)) {
                        if(data[2] !== t) continue;
                        const row = document.createElement('div');
                        row.className = "flex flex-col p-2 bg-slate-800/40 rounded border border-slate-800";
                        
                        let itemInfo = `<span class="uppercase font-bold text-sm text-slate-300">${name}</span>`;
                        itemInfo += `<span class="text-yellow-600 text-sm font-bold block mt-1">${data[0]}G</span>`;
                        
                        row.innerHTML = itemInfo;
                        
                        // Add buttons container
                        const btnContainer = document.createElement('div');
                        btnContainer.className = "flex gap-2 mt-2";
                        
                        // View Stats button
                        const statsBtn = document.createElement('button');
                        statsBtn.className = "flex-1 px-2 py-2 bg-blue-700 hover:bg-blue-600 rounded text-xs font-bold text-white transition-colors";
                        statsBtn.innerText = "VIEW STATS";
                        statsBtn.onclick = () => showItemStats(name, data);
                        
                        // Buy button
                        const buyBtn = document.createElement('button');
                        buyBtn.className = "flex-1 px-2 py-2 bg-slate-700 hover:bg-yellow-700 rounded text-xs font-bold text-white transition-colors";
                        buyBtn.innerText = "BUY";
                        buyBtn.onclick = () => showPurchaseConfirmation(name, data);
                        
                        btnContainer.appendChild(statsBtn);
                        btnContainer.appendChild(buyBtn);
                        row.appendChild(btnContainer);
                        list.appendChild(row);
                    }
                    sect.appendChild(list);
                    container.appendChild(sect);
                }
            } else {
                // Sell Mode
                const sellList = document.createElement('div');
                sellList.className = "grid grid-cols-1 gap-2";
                
                const processCollection = (collection, label) => {
                    for(let name in collection) {
                        if(name === 'stick' || name === 'none') continue;
                        const itemInfo = SHOP_DATA[name];
                        if(!itemInfo) continue;
                        const sellPrice = Math.floor(itemInfo[0] / 2);
                        const count = Array.isArray(collection[name]) ? collection[name][0] : 1;
                        if (count <= 0) continue;

                        const row = document.createElement('div');
                        row.className = "flex justify-between items-center p-3 bg-slate-800/40 rounded border border-slate-700";
                        row.innerHTML = `
                            <div>
                                <span class="text-xs text-slate-500 uppercase font-bold">${label}</span>
                                <div class="text-base font-bold uppercase text-white">${name} ${count>1?'(x'+count+')':''}</div>
                            </div>
                            <button onclick="sellItem('${name}', '${label}')" class="bg-red-900/40 hover:bg-red-800 border border-red-500/30 px-5 py-2 rounded text-sm font-bold text-red-200">
                                SELL FOR ${sellPrice}G
                            </button>
                        `;
                        sellList.appendChild(row);
                    }
                }
                processCollection(stats.weapons, "Weapon");
                processCollection(stats.armors, "Armor");
                processCollection(stats.potions, "Potion");
                processCollection(stats.spells, "Spell");

                if (sellList.children.length === 0) {
                    sellList.innerHTML = `<div class="text-center text-slate-500 py-10 text-sm uppercase font-bold">Nothing to sell</div>`;
                }
                container.appendChild(sellList);
            }
        }

        function showItemStats(name, data) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            const itemType = data[2] === 1 ? 'Weapon' : data[2] === 2 ? 'Armor' : data[2] === 3 ? 'Potion' : 'Spell';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:500px;width:90%;">';
            html += '<h2 style="font-size:1.5rem;font-weight:bold;margin-bottom:1rem;text-align:center;color:white;">ITEM DETAILS</h2>';
            html += '<div style="background:#0f172a;padding:1.5rem;border-radius:8px;margin-bottom:1rem;border:2px solid #334155;">';
            html += `<div style="font-size:1.2rem;font-weight:bold;color:#fbbf24;text-transform:uppercase;margin-bottom:0.5rem;text-align:center;">${name}</div>`;
            html += `<div style="font-size:0.9rem;color:#94a3b8;margin-bottom:1rem;text-align:center;">${itemType}</div>`;
            html += '<div style="border-top:1px solid #334155;padding-top:1rem;">';
            
            // Weapon stats
            if (data[2] === 1) {
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Tier: <span style="color:#fbbf24;font-weight:bold;">${data[1]}</span></div>`;
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Damage: <span style="color:#10b981;font-weight:bold;">${getWeaponDamageDesc(data[1])}</span></div>`;
                html += '<div style="font-size:0.85rem;color:#94a3b8;margin-top:1rem;font-style:italic;">Used for attacking enemies in combat. Higher tier weapons deal more damage.</div>';
            }
            // Armor stats
            else if (data[2] === 2) {
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Armor Class: <span style="color:#3b82f6;font-weight:bold;">${data[1]}</span></div>`;
                html += '<div style="font-size:0.85rem;color:#94a3b8;margin-top:1rem;font-style:italic;">Increases your AC (Armor Class). Higher AC makes you harder to hit in combat.</div>';
            }
            // Potion stats
            else if (data[2] === 3) {
                const potionEffects = {
                    1: {name: "Healing", effect: "Restores 1d4+1d4 HP (2-8 HP)", color: "#10b981"},
                    2: {name: "Intelligence", effect: "Grants +6 temporary Intelligence for one chest opening", color: "#3b82f6"},
                    3: {name: "Speed (Dexterity)", effect: "Grants +6 temporary Dexterity for one retreat attempt", color: "#8b5cf6"},
                    4: {name: "Strength", effect: "Grants +6 temporary Strength for one attack", color: "#ef4444"},
                    5: {name: "Protection", effect: "Grants +3 temporary Armor for one enemy attack", color: "#06b6d4"}
                };
                const effect = potionEffects[data[3]];
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Type: <span style="color:${effect.color};font-weight:bold;">${effect.name}</span></div>`;
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Effect: <span style="color:#fbbf24;font-weight:bold;">${effect.effect}</span></div>`;
                html += '<div style="font-size:0.85rem;color:#94a3b8;margin-top:1rem;font-style:italic;">Consumable item. Can be used in combat or from inventory (healing only).</div>';
            }
            // Spell stats
            else if (data[2] === 4) {
                const spellEffects = {
                    1: {name: "Magic Missile", effect: "1d8 damage, DC 10 Wisdom", color: "#8b5cf6"},
                    2: {name: "Weakness", effect: "1d8 damage + reduce enemy Str by 2, DC 11 Wisdom", color: "#6366f1"},
                    3: {name: "Lightning", effect: "2d6+1d10+3 damage, DC 12 Wisdom", color: "#eab308"},
                    4: {name: "Freeze", effect: "1d6 damage + freeze enemy for 2 turns, DC 10 Wisdom", color: "#06b6d4"},
                    5: {name: "Fireball", effect: "1d15+5 damage + 2 burn damage per turn, DC 11 Wisdom", color: "#f97316"},
                    6: {name: "Town Portal", effect: "Teleport back to town from dungeon", color: "#10b981"}
                };
                const effect = spellEffects[data[3]];
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Spell: <span style="color:${effect.color};font-weight:bold;">${effect.name}</span></div>`;
                html += `<div style="font-size:0.95rem;color:#64748b;margin-bottom:0.5rem;">Effect: <span style="color:#fbbf24;font-weight:bold;">${effect.effect}</span></div>`;
                html += '<div style="font-size:0.85rem;color:#94a3b8;margin-top:1rem;font-style:italic;">Consumable spell. Requires Wisdom check to cast successfully.</div>';
            }
            
            html += '</div>';
            html += `<div style="font-size:1.1rem;font-weight:bold;color:#fbbf24;text-align:center;margin-top:1rem;padding-top:1rem;border-top:1px solid #334155;">Price: ${data[0]} Gold</div>`;
            html += '</div>';
            html += '<button onclick="closeItemStatsModal()" style="width:100%;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">CLOSE</button>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'item-stats-modal';
            document.body.appendChild(modal);
        }

        function closeItemStatsModal() {
            const modal = document.getElementById('item-stats-modal');
            if (modal) modal.remove();
        }

        function showPurchaseConfirmation(name, data) {
            if(stats.coins < data[0]) {
                addLog("Not enough gold!", "text-red-500 font-bold");
                return;
            }

            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            const itemType = data[2] === 1 ? 'Weapon' : data[2] === 2 ? 'Armor' : data[2] === 3 ? 'Potion' : 'Spell';
            let itemDetails = '';
            if (data[2] === 1) {
                // Weapon - show tier and damage
                itemDetails = `Tier ${data[1]} - ${getWeaponDamageDesc(data[1])}`;
            } else if (data[2] === 2) {
                // Armor - show AC
                itemDetails = `AC ${data[1]}`;
            }
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:450px;width:90%;">';
            html += '<h2 style="font-size:1.3rem;font-weight:bold;margin-bottom:1rem;text-align:center;color:white;">CONFIRM PURCHASE</h2>';
            html += '<div style="background:#0f172a;padding:1.5rem;border-radius:8px;margin-bottom:1.5rem;border:2px solid #334155;">';
            html += `<div style="font-size:1.1rem;font-weight:bold;color:#fbbf24;text-transform:uppercase;margin-bottom:0.5rem;">${name}</div>`;
            html += `<div style="font-size:0.85rem;color:#94a3b8;margin-bottom:0.75rem;">${itemType}</div>`;
            if (itemDetails) {
                html += `<div style="font-size:0.9rem;color:#10b981;margin-bottom:0.75rem;font-weight:bold;">${itemDetails}</div>`;
            }
            html += `<div style="font-size:1.2rem;font-weight:bold;color:#fbbf24;">Cost: ${data[0]} Gold</div>`;
            html += `<div style="font-size:0.9rem;color:#64748b;margin-top:0.5rem;">You have: ${stats.coins} Gold</div>`;
            html += '</div>';
            html += '<div style="display:flex;gap:0.75rem;">';
            html += `<button onclick="confirmPurchase('${name}', ${JSON.stringify(data).replace(/"/g, '&quot;')})" style="flex:1;padding:0.75rem;background:#10b981;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">BUY</button>`;
            html += '<button onclick="closePurchaseModal()" style="flex:1;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">CANCEL</button>';
            html += '</div>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'purchase-modal';
            document.body.appendChild(modal);
        }

        function confirmPurchase(name, data) {
            closePurchaseModal();
            
            if(stats.coins >= data[0]) {
                stats.coins -= data[0];
                let itemType = '';
                
                if(data[2] === 1) {
                    stats.weapons[name] = data[1];
                    itemType = 'weapon';
                } else if(data[2] === 2) {
                    stats.armors[name] = data[1];
                    itemType = 'armor';
                } else if(data[2] === 3) {
                    if(!stats.potions[name]) stats.potions[name] = [0, data[3]];
                    stats.potions[name][0]++;
                    itemType = 'consumable';
                } else if(data[2] === 4) {
                    if(!stats.spells[name]) stats.spells[name] = [0, data[3]];
                    stats.spells[name][0]++;
                    itemType = 'consumable';
                }
                
                updateUI();
                addLog(`Purchased ${name}!`, "text-green-400");
                renderShop();
                
                // Ask if they want to equip it (only for weapons and armor)
                if(itemType === 'weapon' || itemType === 'armor') {
                    setTimeout(() => showEquipPrompt(name, itemType), 300);
                }
            } else {
                addLog("Not enough gold!", "text-red-500 font-bold");
            }
        }

        function showEquipPrompt(name, itemType) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
            
            let html = '<div style="background:#1e293b;padding:2rem;border-radius:10px;max-width:400px;width:90%;">';
            html += '<h2 style="font-size:1.3rem;font-weight:bold;margin-bottom:1rem;text-align:center;color:white;">EQUIP ITEM?</h2>';
            html += '<div style="background:#0f172a;padding:1.5rem;border-radius:8px;margin-bottom:1rem;border:2px solid #334155;text-align:center;">';
            html += `<div style="font-size:1.1rem;font-weight:bold;color:#fbbf24;text-transform:uppercase;margin-bottom:0.5rem;">${name}</div>`;
            html += `<div style="font-size:0.9rem;color:#94a3b8;">Would you like to equip this ${itemType} now?</div>`;
            html += '</div>';
            html += `<div style="font-size:0.8rem;color:#64748b;text-align:center;margin-bottom:1.5rem;font-style:italic;">You can always change equipment in your inventory</div>`;
            html += '<div style="display:flex;gap:0.75rem;">';
            html += `<button onclick="equipNewItem('${name}', '${itemType}')" style="flex:1;padding:0.75rem;background:#3b82f6;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">EQUIP NOW</button>`;
            html += '<button onclick="closeEquipModal()" style="flex:1;padding:0.75rem;background:#64748b;border-radius:8px;font-weight:bold;color:white;font-size:0.95rem;cursor:pointer;border:none;">LATER</button>';
            html += '</div>';
            html += '</div>';
            
            modal.innerHTML = html;
            modal.id = 'equip-modal';
            document.body.appendChild(modal);
        }

        function equipNewItem(name, itemType) {
            closeEquipModal();
            
            if(itemType === 'weapon') {
                stats.equippedWeapon = name;
                addLog(`Equipped ${name}!`, "text-blue-400");
            } else if(itemType === 'armor') {
                stats.equippedArmor = name;
                stats.armor = stats.armors[name];
                addLog(`Equipped ${name}!`, "text-blue-400");
            }
            
            updateUI();
        }

        function closePurchaseModal() {
            const modal = document.getElementById('purchase-modal');
            if (modal) modal.remove();
        }

        function closeEquipModal() {
            const modal = document.getElementById('equip-modal');
            if (modal) modal.remove();
        }

        function buyItem(name, data) {
            // Legacy function kept for compatibility
            showPurchaseConfirmation(name, data);
        }

        function sellItem(name, type) {
            const data = SHOP_DATA[name];
            const price = Math.floor(data[0] / 2);
            stats.coins += price;
            
            if (type === "Weapon") {
                if(stats.equippedWeapon === name) stats.equippedWeapon = "stick";
                delete stats.weapons[name];
            } else if (type === "Armor") {
                if(stats.equippedArmor === name) stats.equippedArmor = "none";
                delete stats.armors[name];
                stats.armor = Math.max(...Object.values(stats.armors));
            } else if (type === "Potion") {
                stats.potions[name][0]--;
                if(stats.potions[name][0] <= 0) delete stats.potions[name];
            } else if (type === "Spell") {
                stats.spells[name][0]--;
                if(stats.spells[name][0] <= 0) delete stats.spells[name];
            }
            
            updateUI();
            addLog(`Sold ${name} for ${price}G`, "text-yellow-500");
            renderShop();
        }

        // --- INVENTORY MANAGEMENT ---
        function renderInventory() {
            const wList = document.getElementById('inv-weapons');
            const aList = document.getElementById('inv-armors');
            const cList = document.getElementById('inv-consumables');
            wList.innerHTML = ''; aList.innerHTML = ''; cList.innerHTML = '';

            for(let name in stats.weapons) {
                const b = document.createElement('button');
                const isEquipped = stats.equippedWeapon === name;
                const tier = stats.weapons[name];
                b.className = `w-full p-3 text-left border border-slate-700 rounded transition-all ${isEquipped?'equipped':'bg-slate-800/40 hover:bg-slate-700'}`;
                b.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-base font-bold uppercase">${name}</span>
                        <span class="text-sm text-slate-500 font-bold">TIER ${tier}</span>
                    </div>
                    <div class="text-sm text-green-400 font-bold mt-1">${getWeaponDamageDesc(tier)}</div>
                    ${isEquipped ? '<div class="text-xs text-yellow-500 font-black mt-1 uppercase italic tracking-widest">EQUIPPED</div>' : ''}
                `;
                b.onclick = () => { stats.equippedWeapon = name; renderInventory(); addLog(`Equipped ${name}`); };
                wList.appendChild(b);
            }

            for(let name in stats.armors) {
                const b = document.createElement('button');
                const isEquipped = stats.equippedArmor === name;
                b.className = `w-full p-3 text-left border border-slate-700 rounded transition-all ${isEquipped?'equipped':'bg-slate-800/40 hover:bg-slate-700'}`;
                b.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-base font-bold uppercase">${name}</span>
                        <span class="text-sm text-slate-500 font-bold">AC ${stats.armors[name]}</span>
                    </div>
                    ${isEquipped ? '<div class="text-xs text-yellow-500 font-black mt-1 uppercase italic tracking-widest">EQUIPPED</div>' : ''}
                `;
                b.onclick = () => { 
                    stats.equippedArmor = name; 
                    stats.armor = stats.armors[name];
                    renderInventory(); 
                    updateUI();
                    addLog(`Equipped ${name}`); 
                };
                aList.appendChild(b);
            }

            const consumables = {...stats.potions, ...stats.spells};
            for(let name in consumables) {
                const count = consumables[name][0];
                if(count <= 0) continue;
                
                // Check if this is a healing potion - only healing potions can be used outside combat
                const isHealingPotion = name === 'healing potion';
                const canUse = isHealingPotion && stats.HP < stats.maxHP;
                
                const div = document.createElement('div');
                div.className = `p-3 bg-slate-900 border border-slate-800 rounded ${canUse ? 'cursor-pointer hover:bg-slate-800 transition-colors' : ''}`;
                
                const content = `
                    <div class="flex justify-between items-center">
                        <span class="text-base font-bold uppercase text-slate-300">${name}</span>
                        <div class="flex items-center gap-2">
                            <span class="bg-blue-900/40 px-3 py-1 rounded text-blue-400 font-bold text-sm">x${count}</span>
                            ${canUse ? '<button class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded text-sm font-bold text-white">USE</button>' : ''}
                        </div>
                    </div>
                `;
                
                div.innerHTML = content;
                
                if(canUse) {
                    div.onclick = () => useItemFromInventory(name);
                }
                
                cList.appendChild(div);
            }
            if(cList.innerHTML === '') cList.innerHTML = '<div class="text-sm text-slate-600 uppercase font-bold text-center py-4">No Consumables</div>';
        }

        // --- USE ITEMS FROM INVENTORY (OUTSIDE COMBAT) ---
        function useItemFromInventory(name) {
            if (name === 'healing potion') {
                if (stats.HP >= stats.maxHP) {
                    addLog("Already at full health!", "text-slate-400");
                    return;
                }
                
                if (!stats.potions[name] || stats.potions[name][0] <= 0) {
                    addLog("No healing potions left!", "text-red-400");
                    return;
                }
                
                stats.potions[name][0]--;
                const heal = (Math.floor(Math.random()*4)+1) + (Math.floor(Math.random()*4)+1);
                stats.HP = Math.min(stats.maxHP, stats.HP + heal);
                addLog(`Drank healing potion - Healed ${heal} HP`, "text-green-400");
                
                if(stats.potions[name][0] <= 0) {
                    delete stats.potions[name];
                }
                
                updateUI();
                renderInventory();
            }
        }

        // --- ITEMS IN COMBAT ---
        function renderCombatInventory() {
            const list = document.getElementById('combat-inventory-list');
            list.innerHTML = '';
            const items = {...stats.potions, ...stats.spells};
            for (const [name, data] of Object.entries(items)) {
                if (data[0] > 0) {
                    const b = document.createElement('button');
                    b.className = "w-full p-3 bg-slate-800 text-sm text-left flex justify-between rounded px-4 border border-slate-700 hover:bg-slate-700";
                    b.innerHTML = `<span class="uppercase font-bold text-white">${name}</span><span class="text-yellow-500 font-bold">x${data[0]}</span>`;
                    b.onclick = () => useItem(name);
                    list.appendChild(b);
                }
            }
        }

        async function useItem(name) {
            if (isProcessing) return;
            isProcessing = true;
            const isPotion = stats.potions[name];
            const itemData = isPotion || stats.spells[name];
            if(isPotion) {
                stats.potions[name][0]--;
                const typeId = itemData[1];
                addLog(`Drank ${name}`, "text-blue-300");
                if(typeId === 1) {
                    const heal = (Math.floor(Math.random()*4)+1) + (Math.floor(Math.random()*4)+1);
                    stats.HP = Math.min(stats.maxHP, stats.HP + heal);
                    addLog(`Healed ${heal} HP`, "text-green-400");
                } else if(typeId === 2) stats.temporary_intelligence = 6;
                else if(typeId === 3) stats.temporary_dexterity = 6;
                else if(typeId === 4) stats.temporary_strength = 6;
                else if(typeId === 5) stats.temporary_armor = 3;
                if(stats.potions[name][0] <= 0) delete stats.potions[name];
                isProcessing = false;
                monsterTurnStart();
            } else {
                stats.spells[name][0]--;
                const typeId = itemData[1];
                const need = typeId===1?10 : typeId===2?11 : typeId===3?12 : typeId===4?10 : 11;
                await logLoading("Casting...", 3, 100);
                const roll = Math.floor(Math.random()*20)+1 + Math.floor(stats.wisdom/2)-5;
                addLog(`Wis Roll: ${roll} vs ${need}`);
                if(roll >= need) {
                    addLog("Spell Success!", "text-purple-400 font-bold");
                    if(typeId===2) { combatData.strength -= 2; combatData.change_strength = true; }
                    if(typeId===4) combatData.freeze = 2;
                    if(typeId===5) combatData.fire = true;
                    let dmg = 0;
                    if(typeId===1 || typeId===2) dmg = Math.floor(Math.random()*8)+1;
                    else if(typeId===3) dmg = Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+Math.floor(Math.random()*10)+3;
                    else if(typeId===4) dmg = Math.floor(Math.random()*6)+1;
                    else if(typeId===5) dmg = Math.floor(Math.random()*15)+5;
                    addLog(`Spell dealt ${dmg} damage`, "text-purple-300");
                    combatData.HP -= dmg;
                    if(combatData.HP <= 0) { await victory(); return; }
                } else addLog("Spell Fizzled!", "text-slate-500");
                if(stats.spells[name][0] <= 0) delete stats.spells[name];
                monsterTurnStart();
            }
            updateUI();
        }

        addLog("Welcome to Oakhaven.", "text-slate-500 italic");
        
        // Check authentication on page load
        checkAuth().then(authenticated => {
            if (authenticated) {
                console.log('User authenticated for Dungeon Game');
            }
        });
    </script>

        </main>
        <div class="push"></div>
    </div>

    <footer>
        <p>&copy; 2025 Ahrens Labs. All rights reserved.</p>
    </footer>
</body>
</html>
